<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MLB 공격 시뮬레이터</title>
  <style>
    table { border-collapse: collapse; }
    td, th { border: 1px solid #ccc; padding: 4px; text-align: center; }
    button { margin: 5px; }
  </style>
</head>
<body>

<h2>MLB 공격 시뮬레이터</h2>

<button onclick="applyMLB2025Avg()">2025 MLB 평균 적용</button>
<button onclick="runSimulation()">시뮬레이션 실행</button>
<button onclick="resetAverage()">평균 초기화</button>

<table>
  <thead>
    <tr>
      <th>타순</th>
      <th>PA</th>
      <th>1B</th>
      <th>2B</th>
      <th>3B</th>
      <th>HR</th>
      <th>BB</th>
      <th>HBP</th>
      <th>SO</th>
      <th>SH</th>
    </tr>
  </thead>
  <tbody id="batters"></tbody>
</table>

<h3 id="lastResult">이번 실행 결과: -</h3>
<h3 id="avgResult">누적 평균: -</h3>
<h3 id="countResult">실행 횟수: 0</h3>

<script>
/***********************
 * 입력 UI 생성
 ***********************/
const tbody = document.getElementById("batters");

for (let i = 1; i <= 9; i++) {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${i}</td>
    <td><input id="pa_${i}" value="600"></td>
    <td><input id="single_${i}" value="86"></td>
    <td><input id="double_${i}" value="25"></td>
    <td><input id="triple_${i}" value="2"></td>
    <td><input id="hr_${i}" value="19"></td>
    <td><input id="bb_${i}" value="50"></td>
    <td><input id="hbp_${i}" value="9"></td>
    <td><input id="so_${i}" value="133"></td>
    <td><input id="sh_${i}" value="2"></td>
  `;
  tbody.appendChild(row);
}

/***********************
 * 주루 확률 상수
 ***********************/
const RUN_PROB = {
  single_2B_to_home: [0.45, 0.58, 0.75],
  single_1B_to_3B:   [0.20, 0.28, 0.45],
  double_1B_to_home: [0.45, 0.62, 0.85],
  out_1B_to_2B:      0.25,
  out_2B_to_3B:      0.20,
  out_3B_to_home:    0.05,
  doublePlayProb:    0.10
};

/***********************
 * 확률 테이블 생성
 ***********************/
function buildProb(i) {
  const pa = Number(document.getElementById(`pa_${i}`).value);

  const events = {
    single: Number(document.getElementById(`single_${i}`).value),
    double: Number(document.getElementById(`double_${i}`).value),
    triple: Number(document.getElementById(`triple_${i}`).value),
    homer: Number(document.getElementById(`hr_${i}`).value),
    walk: Number(document.getElementById(`bb_${i}`).value),
    hbp: Number(document.getElementById(`hbp_${i}`).value),
    strikeout: Number(document.getElementById(`so_${i}`).value),
    sacBunt: Number(document.getElementById(`sh_${i}`).value)
  };

  let total = 0;
  for (let k in events) total += events[k];

  const probs = [];
  let acc = 0;

  for (let k in events) {
    acc += events[k] / pa;
    probs.push([acc, k]);
  }

  // 일반 아웃
  probs.push([1, "out"]);
  return probs;
}

/***********************
 * 타석 결과 결정
 ***********************/
function plateAppearance(probTable) {
  const r = Math.random();
  for (let [p, event] of probTable) {
    if (r < p) return event;
  }
  return "out";
}

/***********************
 * 이닝 시뮬레이션
 ***********************/
function simulateInning(batterIndex, probs) {
  let outs = 0;
  let bases = [0, 0, 0];
  let score = 0;

  while (outs < 3) {
    const batter = batterIndex % 9;
    batterIndex++;

    const event = plateAppearance(probs[batter]);
    let newBases = [0, 0, 0];

    // -------------------
    // 삼진
    // -------------------
    if (event === "strikeout") {
      outs++;
    }

    // -------------------
    // 더블플레이
    // -------------------
    else if ((outs === 0 || outs === 1) && bases[0] && Math.random() < RUN_PROB.doublePlayProb) {
      outs += 2;
      // 1루 주자 아웃
      bases[0] = 0;
      // 2루 주자 → 3루
      if (bases[1]) newBases[2] = 1;
      // 3루 주자 → 홈
      if (bases[2]) score++;
      continue; // 이번 타석 종료
    }

    // -------------------
    // 단타
    // -------------------
    else if (event === "single") {
      // 3루 주자 홈
      if (bases[2]) score++;
      // 2루 주자
      if (bases[1]) {
        if (Math.random() < RUN_PROB.single_2B_to_home[outs]) score++;
        else newBases[2] = 1;
      }
      // 1루 주자
      if (bases[0]) {
        if (Math.random() < RUN_PROB.single_1B_to_3B[outs]) newBases[2] = 1;
        else newBases[1] = 1;
      }
      newBases[0] = 1; // 타자 1루
    }

    // -------------------
    // 2루타
    // -------------------
    else if (event === "double") {
      if (bases[2]) score++;
      if (bases[1]) score++;
      if (bases[0]) {
        if (Math.random() < RUN_PROB.double_1B_to_home[outs]) score++;
        else newBases[2] = 1;
      }
      newBases[1] = 1; // 타자 2루
    }

    // -------------------
    // 3루타
    // -------------------
    else if (event === "triple") {
      score += bases[0] + bases[1] + bases[2];
      newBases[2] = 1;
    }

    // -------------------
    // 홈런
    // -------------------
    else if (event === "homer") {
      score += bases[0] + bases[1] + bases[2] + 1;
    }

    // -------------------
    // 볼넷/사구/희생번트
    // -------------------
    else if (["walk", "hbp", "sacBunt"].includes(event)) {
      if (bases[0] && bases[1] && bases[2]) score++;
      newBases = [1, bases[0], bases[1]];
      if (event === "sacBunt") outs++;
    }

    // -------------------
    // 일반 아웃
    // -------------------
    else {
      outs++;
      // 1루→2루
      if (bases[0] && Math.random() < RUN_PROB.out_1B_to_2B) newBases[1] = 1;
      else if (bases[0]) newBases[0] = 1;
      // 2루→3루
      if (bases[1] && Math.random() < RUN_PROB.out_2B_to_3B) newBases[2] = 1;
      else if (bases[1]) newBases[1] = 1;
      // 3루→홈
      if (bases[2] && Math.random() < RUN_PROB.out_3B_to_home) score++;
      else if (bases[2]) newBases[2] = 1;
    }

    bases = newBases;
  }

  return { score, batterIndex };
}

/***********************
 * 전체 시뮬레이션
 ***********************/
let cumulativeScore = 0;
let cumulativeCount = 0;

function runSimulation() {
  const probs = [];
  for (let i = 1; i <= 9; i++) {
    probs.push(buildProb(i));
  }

  let batterIndex = 0;
  let totalScore = 0;

  for (let game = 0; game < 100; game++) {
    for (let inning = 0; inning < 9; inning++) {
      const res = simulateInning(batterIndex, probs);
      totalScore += res.score;
      batterIndex = res.batterIndex;
    }
  }

  cumulativeScore += totalScore / 100;
  cumulativeCount++;

  document.getElementById("lastResult").innerText = `이번 실행 결과: 경기당 평균 ${ (totalScore/100).toFixed(2) } 점`;
  document.getElementById("avgResult").innerText = `누적 평균: ${ (cumulativeScore / cumulativeCount).toFixed(2) } 점`;
  document.getElementById("countResult").innerText = `실행 횟수: ${cumulativeCount}`;
}

function resetAverage() {
  cumulativeScore = 0;
  cumulativeCount = 0;
  document.getElementById("avgResult").innerText = `누적 평균: -`;
  document.getElementById("countResult").innerText = `실행 횟수: 0`;
}

/***********************
 * MLB 2025 평균 적용
 ***********************/
const MLB_2025_AVG = {
  pa: 600,
  single: 86,
  double: 25,
  triple: 2,
  hr: 19,
  bb: 50,
  hbp: 9,
  so: 133,
  sh: 2
};

function applyMLB2025Avg() {
  for (let i = 1; i <= 9; i++) {
    document.getElementById(`pa_${i}`).value = MLB_2025_AVG.pa;
    document.getElementById(`single_${i}`).value = MLB_2025_AVG.single;
    document.getElementById(`double_${i}`).value = MLB_2025_AVG.double;
    document.getElementById(`triple_${i}`).value = MLB_2025_AVG.triple;
    document.getElementById(`hr_${i}`).value = MLB_2025_AVG.hr;
    document.getElementById(`bb_${i}`).value = MLB_2025_AVG.bb;
    document.getElementById(`hbp_${i}`).value = MLB_2025_AVG.hbp;
    document.getElementById(`so_${i}`).value = MLB_2025_AVG.so;
    document.getElementById(`sh_${i}`).value = MLB_2025_AVG.sh;
  }
}
</script>

</body>
</html>

